---
title: "p8130_final"
author: "Zihan Lin"
output: 
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(skimr)
library(skimr)
library(naniar)
library(DataExplorer)
library(knitr)
library(kableExtra)
webshot::install_phantomjs()
library(ggplot2)
library(GGally)
library(janitor)
```

## R Markdown

```{r}
# Load the dataset
data <- read.csv("/Users/suwa/Desktop/p8130_final/data/Project_1_data.csv")

# Inspect the data structure
glimpse(data)  # Overview of the dataset

# Check for missing values
cat("Missing Values Summary:\n")
colSums(is.na(data))  # Count missing values per column

# Handle missing values
data <- data %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))

# For categorical variables, impute missing with the mode
get_mode <- function(x) {
  unique_x <- unique(na.omit(x))
  unique_x[which.max(tabulate(match(x, unique_x)))]
}

data <- data %>%
  mutate(across(where(is.character), ~ ifelse(is.na(.), get_mode(.), .)))

# Check for duplicates
cat("Checking for duplicate rows:\n")
sum(duplicated(data))  # Count duplicate rows

# Remove duplicates if any
data <- data %>% distinct()

# Check for invalid or inconsistent values
cat("Summary of score variables:\n")
summary(data$MathScore)
summary(data$ReadingScore)
summary(data$WritingScore)

# Replace invalid scores (e.g., >100 or <0) with NA
data <- data %>%
  mutate(
    MathScore = ifelse(MathScore < 0 | MathScore > 100, NA, MathScore),
    ReadingScore = ifelse(ReadingScore < 0 | ReadingScore > 100, NA, ReadingScore),
    WritingScore = ifelse(WritingScore < 0 | WritingScore > 100, NA, WritingScore)
  )

# Recheck missing values after cleaning
cat("Missing Values Summary After Cleaning:\n")
colSums(is.na(data))

# Recheck data types and convert if necessary
cat("Converting categorical variables to factors...\n")
data <- data %>%
  mutate(
    Gender = as.factor(Gender),
    EthnicGroup = as.factor(EthnicGroup),
    ParentEduc = as.factor(ParentEduc),
    LunchType = as.factor(LunchType),
    TestPrep = as.factor(TestPrep),
    ParentMaritalStatus = as.factor(ParentMaritalStatus),
    PracticeSport = as.factor(PracticeSport),
    IsFirstChild = as.factor(IsFirstChild),
    TransportMeans = as.factor(TransportMeans),
    WklyStudyHours = as.factor(WklyStudyHours)
  )

# Standardize numeric variables (if needed for modeling)
# Example: Scale test scores
data <- data %>%
  mutate(across(c(MathScore, ReadingScore, WritingScore), scale))

# Save Cleaned Data
write.csv(data, "/Users/suwa/Desktop/p8130_final/data/data_cleaned.csv", row.names = FALSE)
```

```{r}
# Reload the dataset
data <- read.csv("/Users/suwa/Desktop/p8130_final/data/data_cleaned.csv")

# Generate a summary table
skim(data)
```



```{r}
# Distributions of Test Scores
# Histograms for each test score
data %>%
  select(MathScore, ReadingScore, WritingScore) %>%
  pivot_longer(everything(), names_to = "Test", values_to = "Score") %>%
  ggplot(aes(x = Score, fill = Test)) +
  geom_histogram(binwidth = 5, alpha = 0.7, position = "dodge") +
  labs(title = "Distributions of Test Scores", x = "Score", y = "Frequency") +
  theme_minimal()

# Boxplots for test scores
data %>%
  select(MathScore, ReadingScore, WritingScore) %>%
  pivot_longer(everything(), names_to = "Test", values_to = "Score") %>%
  ggplot(aes(x = Test, y = Score, fill = Test)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Boxplots of Test Scores", x = "Test", y = "Score") +
  theme_minimal()

```

```{r}
# Boxplots for Categorical Covariates vs Test Scores
# Explore relationships between categorical covariates and test scores
data %>%
  pivot_longer(cols = c(MathScore, ReadingScore, WritingScore),
               names_to = "TestType", values_to = "Score") %>%
  ggplot(aes(x = Gender, y = Score, fill = Gender)) +
  geom_boxplot(alpha = 0.7) +
  facet_wrap(~TestType, scales = "free") +
  labs(title = "Test Scores by Gender",
       x = "Gender",
       y = "Score") +
  theme_minimal()
```

```{r}
# Distributions of Covariates
# Bar plots for categorical variables
categorical_vars <- data %>%
  select(where(is.factor))

for (var in names(categorical_vars)) {
  print(
    ggplot(data, aes_string(x = var, fill = var)) +
      geom_bar(alpha = 0.7) +
      labs(title = paste("Distribution of", var), x = var, y = "Count") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  )
}

# Histograms for numeric covariates
numeric_vars <- data %>%
  select(where(is.numeric), -c(MathScore, ReadingScore, WritingScore))

for (var in names(numeric_vars)) {
  print(
    ggplot(data, aes_string(x = var)) +
      geom_histogram(binwidth = 1, fill = "steelblue", alpha = 0.7) +
      labs(title = paste("Distribution of", var), x = var, y = "Frequency") +
      theme_minimal()
  )
}
```

```{r}
# Pairwise Relationships
# Scatterplots of test scores
data %>%
  ggplot(aes(x = MathScore, y = ReadingScore)) +
  geom_point(alpha = 0.6, color = "blue") +
  labs(title = "Scatterplot: Math vs. Reading Scores", x = "Math Score", y = "Reading Score") +
  theme_minimal()

data %>%
  ggplot(aes(x = MathScore, y = WritingScore)) +
  geom_point(alpha = 0.6, color = "green") +
  labs(title = "Scatterplot: Math vs. Writing Scores", x = "Math Score", y = "Writing Score") +
  theme_minimal()

data %>%
  ggplot(aes(x = ReadingScore, y = WritingScore)) +
  geom_point(alpha = 0.6, color = "purple") +
  labs(title = "Scatterplot: Reading vs. Writing Scores", x = "Reading Score", y = "Writing Score") +
  theme_minimal()
```


```{r}
# Correlation heatmap
corr_matrix <- cor(numeric_vars, use = "complete.obs")

corr_matrix %>%
  as.data.frame() %>%
  rownames_to_column(var = "Variable1") %>%
  pivot_longer(cols = -Variable1, names_to = "Variable2", values_to = "Correlation") %>%
  ggplot(aes(x = Variable1, y = Variable2, fill = Correlation)) +
  geom_tile(color = "white") +  # Add grid lines
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  labs(title = "Correlation Heatmap", x = "Variable", y = "Variable", fill = "Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10))
```

```{r}
# Boxplots for test scores by EthnicGroup
data %>%
  pivot_longer(cols = c(MathScore, ReadingScore, WritingScore), names_to = "TestType", values_to = "Score") %>%
  ggplot(aes(x = EthnicGroup, y = Score, fill = EthnicGroup)) +
  geom_boxplot() +
  facet_wrap(~ TestType, scales = "free") +
  theme_minimal() +
  labs(title = "Test Scores by Ethnic Group", x = "Ethnic Group", y = "Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Findings from Exploratory Data Analysis (EDA)

Pairwise Relationships:

Strong correlations between MathScore, ReadingScore, and WritingScore (r â‰ˆ 0.95), suggesting redundancy in predictors for individual models. Weak correlation between NrSiblings and test scores. Visualizations indicate potential interaction effects, for example, between Gender and LunchType on MathScore.

Distributions:

Numeric variables like MathScore, ReadingScore, and WritingScore exhibit nearly normal distributions but with some skewness in scores below 50. NrSiblings is positively skewed with most values concentrated around 1 to 3.

Interactions and Covariate Effects:

Boxplots reveal that WklyStudyHours and EthnicGroup significantly impact test scores. Students with more than 10 hours of study time score higher across all test types.

Covariate Analysis:

Weekly study hours (WklyStudyHours) and test preparation (TestPrep) have clear separations in performance, suggesting strong predictive potential. Interaction plots highlight a differential impact of LunchType based on Gender.